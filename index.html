<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูุชุงุจ ุงููุฑุงุฆุถ โ ูุณุฎุฉ ููุญูุธ</title>

  <!-- Arabic-friendly fonts (works if online; fallback if offline) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14;
      --card:#121926;
      --card2:#0f1622;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:#223046;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(167,139,250,.18), transparent 55%),
                  radial-gradient(900px 600px at 100% 0%, rgba(125,211,252,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: "Noto Naskh Arabic","Amiri", system-ui, sans-serif;
      line-height:1.85;
    }

    header{
      position: sticky;
      top:0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(11,15,20,.7);
      border-bottom:1px solid rgba(34,48,70,.6);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .title{
      font-weight:700;
      letter-spacing:.2px;
      font-size:20px;
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(125,211,252,.12);
      border:1px solid rgba(125,211,252,.25);
      color: var(--accent);
    }

    .controls{
      margin-inline-start:auto;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .input, .btn, select{
      border-radius: 12px;
      border:1px solid rgba(34,48,70,.8);
      background: rgba(18,25,38,.85);
      color: var(--text);
      padding:10px 12px;
      outline:none;
      box-shadow: none;
      font-family: inherit;
    }
    .input{min-width: 260px}
    .btn{
      cursor:pointer;
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{border-color: rgba(125,211,252,.6)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(125,211,252,.22), rgba(167,139,250,.18));
      border-color: rgba(125,211,252,.45);
    }
    .btn.ghost{
      background: rgba(18,25,38,.55);
    }

    main{padding: 18px 0 50px}
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .input{min-width: 180px}
    }

    .panel{
      background: linear-gradient(180deg, rgba(18,25,38,.88), rgba(15,22,34,.78));
      border:1px solid rgba(34,48,70,.75);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .head{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(34,48,70,.75);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panel .head h3{
      margin:0;
      font-size:16px;
      color: var(--text);
    }
    .panel .body{padding: 12px 14px 14px}

    .toc a{
      display:block;
      text-decoration:none;
      color: var(--text);
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      transition: background .15s ease, border-color .15s ease;
    }
    .toc a small{display:block; color: var(--muted); margin-top:2px}
    .toc a:hover{
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.25);
    }
    .toc a.active{
      background: rgba(167,139,250,.12);
      border-color: rgba(167,139,250,.30);
    }

    .content{
      padding: 18px 18px 30px;
    }
    .section{
      padding: 16px 16px;
      border:1px solid rgba(34,48,70,.75);
      border-radius: var(--radius);
      background: rgba(18,25,38,.55);
      margin-bottom: 14px;
    }
    .section h2{
      margin:0 0 8px;
      font-size:20px;
    }
    .meta{
      color: var(--muted);
      font-size: 13px;
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }

    /* memorization tools */
    .tools{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 10px 0 0;
    }

    details{
      border:1px solid rgba(34,48,70,.7);
      border-radius: 14px;
      background: rgba(15,22,34,.55);
      padding: 10px 12px;
      margin: 10px 0 0;
    }
    summary{
      cursor:pointer;
      color: var(--accent);
      font-weight:600;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}

    .flashgrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 700px){ .flashgrid{grid-template-columns:1fr} }

    .card{
      border:1px solid rgba(34,48,70,.75);
      border-radius: 16px;
      background: rgba(11,15,20,.25);
      padding: 12px 12px;
    }
    .card .q{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .card .a{
      font-size: 18px;
      font-weight:700;
    }
    .card .reveal{
      margin-top:8px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    mark{
      background: rgba(251,191,36,.25);
      color: var(--text);
      padding: 0 .15em;
      border-radius: 6px;
    }

    .footer{
      color: var(--muted);
      font-size: 12px;
      padding: 10px 0 0;
    }

    .progress{
      height: 10px;
      border-radius: 999px;
      background: rgba(34,48,70,.6);
      overflow:hidden;
      border:1px solid rgba(34,48,70,.8);
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(125,211,252,.9), rgba(167,139,250,.9));
      transition: width .2s ease;
    }

    .note{
      width:100%;
      min-height: 110px;
      resize: vertical;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(34,48,70,.75);
      background: rgba(18,25,38,.55);
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        ูุชุงุจ ุงููุฑุงุฆุถ โ ูุณุฎุฉ ููุญูุธ
        <span class="badge">ุจุญุซ โข ุจุทุงูุงุช โข ุงุฎุชุจุงุฑ</span>
      </div>

      <div class="controls">
        <input id="search" class="input" type="search" placeholder="ุงุจุญุซ ูู ุงููุต..." />
        <button class="btn ghost" id="toggleMarks">ุฅุฎูุงุก/ุฅุธูุงุฑ ุงูุชุญุฏูุฏ</button>
        <button class="btn primary" id="toggleFocus">ูุถุน ุงูุญูุธ</button>
        <select id="fontSize" title="ุญุฌู ุงูุฎุท">
          <option value="18">18</option>
          <option value="20" selected>20</option>
          <option value="22">22</option>
          <option value="24">24</option>
          <option value="26">26</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <div class="pill">ุงูุตูุญุงุช: HTML</div>
      <div class="pill" id="stats">0 ูุณู โข 0 ุจุทุงูุฉ</div>
      <div style="flex:1"></div>
      <div style="min-width:240px; width:320px;">
        <div class="progress" title="ุชูุฏูู ุงููุฑุงุกุฉ">
          <div id="bar"></div>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- Sidebar -->
    <aside class="panel">
      <div class="head">
        <h3>ููุฑุณ</h3>
        <button class="btn ghost" id="clearProgress">ุชุตููุฑ ุงูุชูุฏูู</button>
      </div>
      <div class="body">
        <div class="toc" id="toc"></div>

        <details>
          <summary>๐ ููุงุญุธุงุชู</summary>
          <textarea id="notes" class="input note" placeholder="ุงูุชุจ ููุงุญุธุงุชู ููุง... (ุชูุญูุธ ุชููุงุฆูุงู)"></textarea>
        </details>

        <details>
          <summary>๐ง ุงุฎุชุจุงุฑ ุณุฑูุน (Flash Quiz)</summary>
          <div id="quiz"></div>
          <div class="tools">
            <button class="btn primary" id="newQuiz">ุงุฎุชุจุงุฑ ุฌุฏูุฏ</button>
            <button class="btn ghost" id="showAnswers">ุฅุธูุงุฑ ุงูุฅุฌุงุจุงุช</button>
          </div>
        </details>

        <div class="footer">
          โ ูู ุดูุก ูุญูุธ ุชููุงุฆูุงู ูู ุฌูุงุฒู (LocalStorage).<br>
          โก ุงูุชุญ ุงูููู ุนูู ุงููุงุชู ููุดุชุบู ูุซู ูุชุงุจ.
        </div>
      </div>
    </aside>

    <!-- Content -->
    <section class="panel">
      <div class="head">
        <h3 id="currentTitle">ุงููุญุชูู</h3>
        <div class="tools">
          <button class="btn ghost" id="bookmarkBtn">โญ ุญูุธ ุนูุงูุฉ</button>
          <button class="btn ghost" id="copyLinkBtn">๐ ูุณุฎ ุฑุงุจุท ุงููุณู</button>
        </div>
      </div>

      <div class="content" id="content"></div>
    </section>
  </div>
</main>

<script>
/**
 * ====== CONTENT (Paste your Arabic text here) ======
 * Structure: sections[] each has id, title, subtitle, body, flashcards[], quiz[]
 */
const sections = [
  {
    id: "t1",
    title: "ุชุนุฑูู ุงูููุฑุงุซ ูุบุฉู ูุงุตุทูุงุญูุง",
    subtitle: "ูุต + ุจุทุงูุงุช ููุญูุธ",
    body: `
<p><b>ุชุนุฑูู ุงูููุฑุงุซ ูุบุฉู:</b> ุงูููุฑุงุซ ูุตุฏุฑ ูู ูุฑุซุ ููู ุงูุชูุงู ุงูุดูุก ูู ุดุฎุต ุฅูู ุดุฎุต ุขุฎุฑ...</p>
<p><b>ูุงุตุทูุงุญูุง:</b> ุนุจุงุฑุฉ ุนู ุงูุชูุงู ููู ุฃุญุฏ ุจุณุจุจ ุงูููุช ุฅูู ูุฑุซุชู ุงูุญููููุฉ.</p>
`,
    flashcards: [
      {q:"ุชุนุฑูู ุงูููุฑุงุซ ูุบุฉูุ", a:"ุงูุชูุงู ุงูุดูุก ูู ุดุฎุต ุฅูู ุดุฎุต ุขุฎุฑ."},
      {q:"ุชุนุฑูู ุงูููุฑุงุซ ุงุตุทูุงุญูุงุ", a:"ุงูุชูุงู ููู ุฃุญุฏ ุจุณุจุจ ุงูููุช ุฅูู ูุฑุซุชู."}
    ],
    quiz: [
      {q:"ูู ุนุฏุฏ ุฃุฑูุงู ุงูููุฑุงุซุ", a:"ุซูุงุซุฉ"},
      {q:"ุงุฐูุฑ ุณุจุจูู ูู ุฃุณุจุงุจ ุงูุฅุฑุซ.", a:"ุงููุณุจุ ุงูููุงุญ (ูุฃูุถูุง ุงูููุงุกุ ุจูุช ุงููุงู ุนูุฏ ุนุฏู ุงููุงุฑุซ)"}
    ]
  },

  {
    id: "t2",
    title: "ุชุนุฑูู ุนูู ุงููุฑุงุฆุถ",
    subtitle: "ูุฎุชุตุฑ ูุงุถุญ",
    body: `
<p>ูู ุนูู ููุจุญุซ ููู ุนู ุงูุชูุงู ููู ุงูููุช ุฅูู ูุฑุซุชู ุงูุฃุญูุงุกุ ูุนู ุฃุญูุงู ุงููุฑุซุฉุ ูุงูุณูุงู ุงูููุฏูุฑุฉ...</p>
`,
    flashcards: [
      {q:"ูุง ููุถูุน ุนูู ุงููุฑุงุฆุถุ", a:"ุงูุชุฑูุฉ ูุงูุณูุงู ููุณุชุญูููุง."},
      {q:"ููุงุฐุง ุณูู ุนูู ุงููุฑุงุฆุถุ", a:"ูุฃู ูุณุงุฆูู ูุจููุฉ ุนูู ุงููุฑูุถ ุงูููุฏูุฑุฉ."}
    ],
    quiz: [
      {q:"ุงุฐูุฑ ูุตุงุฏุฑ ุนูู ุงูููุฑุงุซ.", a:"ุงููุชุงุจุ ุงูุณูุฉุ ุงูุฅุฌูุงุน"}
    ]
  },

  {
    id: "t3",
    title: "ุงููุตุทูุญุงุช ุงูุฃุณุงุณูุฉ",
    subtitle: "ุชุนุฑููุงุช ูุฑููุฒุฉ ููุญูุธ",
    body: `
<ul>
  <li><b>ุงููุฑุถ:</b> ูู ุงููุตูุจ ุงูููุฏุฑ ุดุฑุนูุง ูููุงุฑุซ...</li>
  <li><b>ุงูุณูู:</b> ูู ุงูุฌุฒุก ุงููุนูู ุงูุฐู ูุนุทู ููู ูุงุฑุซ...</li>
  <li><b>ุงูุชุฑูุฉ:</b> ูุง ุชุฑูู ุงูููุช ูู ุงูุฃููุงู ูุงูุญููู...</li>
  <li><b>ุงูุณุจุจ:</b> ูุง ูููู ุณุจุจูุง ููุฅุฑุซ ูุงูููุงุญ ูุงูููุงุก...</li>
</ul>
`,
    flashcards: [
      {q:"ูุง ูู ุงููุฑุถุ", a:"ุงููุตูุจ ุงูููุฏุฑ ุดุฑุนูุง ูููุงุฑุซ."},
      {q:"ูุง ูู ุงูุชุฑูุฉุ", a:"ูุง ุชุฑูู ุงูููุช ูู ุงูุฃููุงู ูุงูุญููู."}
    ],
    quiz: [
      {q:"ุงูุณุจุจ ูู ุฃูุซูุชูุ", a:"ุงูููุงุญ ูุงูููุงุก"}
    ]
  },

  {
    id: "t4",
    title: "ุฃุฑูุงู ุงูููุฑุงุซ + ุฃุณุจุงุจ ุงูุฅุฑุซ + ุดุฑูุท ุงูุฅุฑุซ",
    subtitle: "ุซูุงุซูุงุช ููุญูุธ ุงูุณุฑูุน",
    body: `
<p><b>ุฃุฑูุงู ุงูููุฑุงุซ:</b> ุงูููุฑุซุ ุงููุงุฑุซุ ุงูุชุฑูุฉ.</p>
<p><b>ุฃุณุจุงุจ ุงูุฅุฑุซ:</b> ุงููุณุจุ ุงูููุงุญุ ุงูููุงุกุ ุจูุช ุงููุงู ุนูุฏ ุนุฏู ุงููุงุฑุซ.</p>
<p><b>ุดุฑูุท ุงูุฅุฑุซ:</b> ุชุญูู ููุช ุงูููุฑุซุ ุชุญูู ุญูุงุฉ ุงููุงุฑุซุ ุงูุนูู ุจุงูุฌูุฉ ุงูููุชุถูุฉ ููุฅุฑุซ.</p>
`,
    flashcards: [
      {q:"ุฃุฑูุงู ุงูููุฑุงุซุ", a:"ุงูููุฑุซุ ุงููุงุฑุซุ ุงูุชุฑูุฉ."},
      {q:"ุดุฑูุท ุงูุฅุฑุซุ", a:"ููุช ุงูููุฑุซุ ุญูุงุฉ ุงููุงุฑุซุ ุงูุนูู ุจุงูุฌูุฉ."}
    ],
    quiz: [
      {q:"ุงุฐูุฑ ุณุจุจูุง ุบูุฑ ุงููุณุจ.", a:"ุงูููุงุญ ุฃู ุงูููุงุก"}
    ]
  },

  {
    id: "t5",
    title: "ุงูุชุฏุฑูุจ",
    subtitle: "ุฃุณุฆูุฉ ูุฑุงุฌุนุฉ",
    body: `
<ol>
  <li>ุงุฐูุฑ ุชุนุฑูู ุนูู ุงูููุฑุงุซุ ูููุถูุนูุ ููุงุฆุฏุชู.</li>
  <li>ุจููู ุฃุฑูุงู ุงูููุฑุงุซ ูุฃุณุจุงุจู.</li>
  <li>ูุง ูู ุดุฑูุท ุงูุฅุฑุซุ</li>
  <li>ุงุฐูุฑ ุจุนุถ ุงููุตุทูุญุงุช ุงูุฃุณุงุณูุฉ ูุนูู ุงูููุฑุงุซ.</li>
</ol>
`
  }
];

/* ====== UI RENDER ====== */
const $ = (s)=>document.querySelector(s);
const toc = $("#toc");
const content = $("#content");
const search = $("#search");
const stats = $("#stats");
const bar = $("#bar");
const currentTitle = $("#currentTitle");

const LS = {
  key: "faraid_book_v1",
  load(){ try{ return JSON.parse(localStorage.getItem(this.key) || "{}"); }catch(e){ return {}; } },
  save(data){ localStorage.setItem(this.key, JSON.stringify(data)); }
};

let state = LS.load();
state.progress = state.progress || {};      // sectionId -> percentRead (0/1 simple)
state.bookmark = state.bookmark || null;    // sectionId
state.notes = state.notes || "";
state.focus = state.focus || false;
state.hideMarks = state.hideMarks || false;
state.fontSize = state.fontSize || 20;

function renderTOC(){
  toc.innerHTML = "";
  sections.forEach((sec, i)=>{
    const a = document.createElement("a");
    a.href = "#" + sec.id;
    a.dataset.id = sec.id;
    a.innerHTML = `${sec.title}<small>${sec.subtitle || "ูุณู"} โข ${i+1}/${sections.length}</small>`;
    a.onclick = (e)=>{ e.preventDefault(); goTo(sec.id); };
    toc.appendChild(a);
  });
}

function renderContent(){
  content.innerHTML = "";
  let cardCount = 0;

  sections.forEach((sec)=>{
    const div = document.createElement("div");
    div.className = "section";
    div.id = sec.id;

    const metaBits = [];
    if (sec.subtitle) metaBits.push(sec.subtitle);
    if (sec.flashcards?.length) metaBits.push(`ุจุทุงูุงุช: ${sec.flashcards.length}`);
    if (sec.quiz?.length) metaBits.push(`ุฃุณุฆูุฉ: ${sec.quiz.length}`);

    div.innerHTML = `
      <h2>${sec.title}</h2>
      <div class="meta">${metaBits.map(x=>`<span class="pill">${x}</span>`).join("")}</div>
      <div class="text" style="font-size:${state.fontSize}px">${sec.body || ""}</div>
      ${sec.flashcards?.length ? flashHTML(sec.flashcards, sec.id) : ""}
      <div class="tools">
        <button class="btn ghost" data-mark="${sec.id}">โ ุชู</button>
        <button class="btn ghost" data-top="${sec.id}">โฌ๏ธ ููุฃุนูู</button>
      </div>
    `;
    content.appendChild(div);

    cardCount += (sec.flashcards?.length || 0);
  });

  stats.textContent = `${sections.length} ูุณู โข ${cardCount} ุจุทุงูุฉ`;
  attachSectionButtons();
}

function flashHTML(cards, secId){
  const html = cards.map((c, idx)=>`
    <div class="card" data-flash="${secId}:${idx}">
      <div class="q">ุณุคุงู</div>
      <div class="a">${escapeHTML(c.q)}</div>
      <div class="reveal">
        <button class="btn primary" data-reveal="${secId}:${idx}">ุฃุธูุฑ ุงูุฌูุงุจ</button>
        <span class="pill" data-answer="${secId}:${idx}" style="display:none">ุงูุฌูุงุจ: ${escapeHTML(c.a)}</span>
      </div>
    </div>
  `).join("");

  return `
    <details>
      <summary>๐ง ุจุทุงูุงุช ููุญูุธ (ุงูุชุญ)</summary>
      <div class="flashgrid">${html}</div>
    </details>
  `;
}

function attachSectionButtons(){
  content.querySelectorAll("[data-reveal]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-reveal");
      const ans = content.querySelector(`[data-answer="${id}"]`);
      if (!ans) return;
      const isHidden = ans.style.display === "none";
      ans.style.display = isHidden ? "inline-flex" : "none";
      btn.textContent = isHidden ? "ุฃุฎูู ุงูุฌูุงุจ" : "ุฃุธูุฑ ุงูุฌูุงุจ";
      updateProgress();
    });
  });

  content.querySelectorAll("[data-mark]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-mark");
      state.progress[id] = 1;
      save();
      updateTOCActive(id);
      updateProgress();
      toast("ุชู โ");
    });
  });

  content.querySelectorAll("[data-top]").forEach(btn=>{
    btn.addEventListener("click", ()=> window.scrollTo({top:0, behavior:"smooth"}));
  });
}

function updateTOCActive(id){
  toc.querySelectorAll("a").forEach(a=>a.classList.toggle("active", a.dataset.id === id));
  const sec = sections.find(s=>s.id===id);
  if (sec) currentTitle.textContent = sec.title;
}

function goTo(id){
  const el = document.getElementById(id);
  if (!el) return;
  el.scrollIntoView({behavior:"smooth", block:"start"});
  updateTOCActive(id);
  // update URL hash
  history.replaceState(null, "", "#" + id);
}

function updateProgress(){
  const done = Object.values(state.progress).filter(v=>v===1).length;
  const pct = Math.round((done / sections.length) * 100);
  bar.style.width = pct + "%";
}

function applyFocusMode(){
  document.body.style.filter = state.focus ? "none" : "none";
  // focus mode: hide sidebar a bit
  const grid = document.querySelector(".grid");
  if (state.focus){
    grid.style.gridTemplateColumns = "1fr";
    document.querySelector("aside.panel").style.display = "none";
  } else {
    grid.style.gridTemplateColumns = "";
    document.querySelector("aside.panel").style.display = "";
  }
  $("#toggleFocus").textContent = state.focus ? "ุฅูุบุงุก ูุถุน ุงูุญูุธ" : "ูุถุน ุงูุญูุธ";
}

function applyMarks(){
  $("#toggleMarks").textContent = state.hideMarks ? "ุฅุธูุงุฑ ุงูุชุญุฏูุฏ" : "ุฅุฎูุงุก/ุฅุธูุงุฑ ุงูุชุญุฏูุฏ";
  // no global marks by default, but search highlights use <mark>
  // we simply remove marks if hidden
  if (state.hideMarks){
    content.querySelectorAll("mark").forEach(m=>{
      const t = document.createTextNode(m.textContent);
      m.replaceWith(t);
    });
  }
}

function applyFontSize(){
  $("#fontSize").value = String(state.fontSize);
  content.querySelectorAll(".text").forEach(t=>{
    t.style.fontSize = state.fontSize + "px";
  });
}

/* ====== SEARCH ====== */
function doSearch(q){
  // remove old marks
  content.querySelectorAll("mark").forEach(m=>{
    const t = document.createTextNode(m.textContent);
    m.replaceWith(t);
  });
  if (!q || state.hideMarks) return;

  const rx = new RegExp(escapeRegExp(q), "g");
  // highlight inside sections text only
  content.querySelectorAll(".text").forEach(node=>{
    const html = node.innerHTML;
    node.innerHTML = html.replace(rx, (m)=>`<mark>${m}</mark>`);
  });
}

/* ====== QUIZ ====== */
function buildQuiz(){
  const pool = [];
  sections.forEach(sec=>{
    (sec.quiz || []).forEach(item=> pool.push({secId: sec.id, ...item}));
  });
  const quizBox = $("#quiz");
  quizBox.innerHTML = "";

  if (!pool.length){
    quizBox.innerHTML = `<div class="pill">ูุง ููุฌุฏ ุงุฎุชุจุงุฑ ูู ูุฐุง ุงููุต.</div>`;
    return;
  }

  // pick 5 random
  const pick = shuffle([...pool]).slice(0, Math.min(5, pool.length));
  pick.forEach((item, i)=>{
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="q">ุณุคุงู ${i+1} โข ูู ูุณู: <b>${sections.find(s=>s.id===item.secId)?.title || item.secId}</b></div>
      <div class="a">${escapeHTML(item.q)}</div>
      <div class="reveal">
        <span class="pill ans" style="display:none">ุงูุฌูุงุจ: ${escapeHTML(item.a)}</span>
        <button class="btn primary show">ุฃุธูุฑ ุงูุฌูุงุจ</button>
        <button class="btn ghost goto" title="ุงุฐูุจ ูููุณู">ุงุฐูุจ</button>
      </div>
    `;
    wrap.querySelector(".show").onclick = ()=>{
      const ans = wrap.querySelector(".ans");
      const isHidden = ans.style.display === "none";
      ans.style.display = isHidden ? "inline-flex" : "none";
    };
    wrap.querySelector(".goto").onclick = ()=> goTo(item.secId);
    quizBox.appendChild(wrap);
  });
}

$("#newQuiz").addEventListener("click", buildQuiz);
$("#showAnswers").addEventListener("click", ()=>{
  document.querySelectorAll("#quiz .ans").forEach(a=> a.style.display="inline-flex");
});

/* ====== BUTTONS ====== */
$("#toggleFocus").addEventListener("click", ()=>{
  state.focus = !state.focus;
  save();
  applyFocusMode();
});

$("#toggleMarks").addEventListener("click", ()=>{
  state.hideMarks = !state.hideMarks;
  save();
  applyMarks();
  doSearch(search.value.trim());
});

$("#clearProgress").addEventListener("click", ()=>{
  state.progress = {};
  save();
  updateProgress();
  toast("ุชู ุงูุชุตููุฑ.");
});

$("#bookmarkBtn").addEventListener("click", ()=>{
  const id = location.hash?.slice(1) || sections[0].id;
  state.bookmark = id;
  save();
  toast("ุชู ุญูุธ ุงูุนูุงูุฉ โญ");
});

$("#copyLinkBtn").addEventListener("click", async ()=>{
  const id = location.hash?.slice(1) || sections[0].id;
  const url = location.origin + location.pathname + "#" + id;
  try{
    await navigator.clipboard.writeText(url);
    toast("ุชู ูุณุฎ ุงูุฑุงุจุท ๐");
  }catch(e){
    toast("ูุง ูุฏุฑ ููุณุฎ (ุตูุงุญูุงุช ุงููุชุตูุญ).");
  }
});

/* ====== NOTES ====== */
const notes = $("#notes");
notes.value = state.notes || "";
notes.addEventListener("input", ()=>{
  state.notes = notes.value;
  save();
});

/* ====== SEARCH INPUT ====== */
search.addEventListener("input", ()=>{
  doSearch(search.value.trim());
});

/* ====== FONT SIZE ====== */
$("#fontSize").addEventListener("change", (e)=>{
  state.fontSize = parseInt(e.target.value, 10);
  save();
  applyFontSize();
});

/* ====== HELPERS ====== */
function save(){ LS.save(state); }

function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function toast(msg){
  const t = document.createElement("div");
  t.textContent = msg;
  t.style.position="fixed";
  t.style.bottom="18px";
  t.style.left="18px";
  t.style.padding="10px 12px";
  t.style.borderRadius="14px";
  t.style.background="rgba(18,25,38,.92)";
  t.style.border="1px solid rgba(34,48,70,.8)";
  t.style.boxShadow="0 10px 30px rgba(0,0,0,.35)";
  t.style.zIndex="999";
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 1400);
}

/* ====== INIT ====== */
renderTOC();
renderContent();
applyFocusMode();
applyMarks();
applyFontSize();
buildQuiz();
updateProgress();

const initial = location.hash?.slice(1) || state.bookmark || sections[0].id;
setTimeout(()=> goTo(initial), 50);

window.addEventListener("scroll", ()=>{
  // set active by nearest section in view
  const tops = sections.map(s=>{
    const el = document.getElementById(s.id);
    if(!el) return {id:s.id, top: Infinity};
    const r = el.getBoundingClientRect();
    return {id:s.id, top: Math.abs(r.top - 120)};
  }).sort((a,b)=>a.top-b.top);
  if(tops[0]) updateTOCActive(tops[0].id);
});
</script>
</body>
</html>
