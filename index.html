<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูุชุงุจ ุงููุฑุงุฆุถ โ ูุณุฎุฉ ููุญูุธ v2.0</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14;
      --card:#121926;
      --card2:#0f1622;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:#223046;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(167,139,250,.18), transparent 55%),
                  radial-gradient(900px 600px at 100% 0%, rgba(125,211,252,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: "Noto Naskh Arabic","Amiri", system-ui, sans-serif;
      line-height:1.85;
      transition: background 0.3s ease;
    }

    /* Light theme */
    body.light{
      --bg:#f8fafc;
      --card:#ffffff;
      --card2:#f1f5f9;
      --text:#1e293b;
      --muted:#64748b;
      --line:#cbd5e1;
      --accent:#0284c7;
      --accent2:#7c3aed;
      --shadow: 0 4px 20px rgba(0,0,0,.08);
    }
    body.light{
      background: radial-gradient(1200px 800px at 20% -10%, rgba(167,139,250,.08), transparent 55%),
                  radial-gradient(900px 600px at 100% 0%, rgba(125,211,252,.06), transparent 60%),
                  var(--bg);
    }
    body.light header{
      background: rgba(248,250,252,.85);
      border-bottom-color: rgba(203,213,225,.6);
    }

    header{
      position: sticky;
      top:0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(11,15,20,.7);
      border-bottom:1px solid rgba(34,48,70,.6);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .title{
      font-weight:700;
      letter-spacing:.2px;
      font-size:20px;
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(125,211,252,.12);
      border:1px solid rgba(125,211,252,.25);
      color: var(--accent);
    }

    .controls{
      margin-inline-start:auto;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .input, .btn, select{
      border-radius: 12px;
      border:1px solid rgba(34,48,70,.8);
      background: rgba(18,25,38,.85);
      color: var(--text);
      padding:10px 12px;
      outline:none;
      box-shadow: none;
      font-family: inherit;
    }
    .input{min-width: 260px}
    .btn{
      cursor:pointer;
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{border-color: rgba(125,211,252,.6)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(125,211,252,.22), rgba(167,139,250,.18));
      border-color: rgba(125,211,252,.45);
    }
    .btn.ghost{
      background: rgba(18,25,38,.55);
    }

    main{padding: 18px 0 50px}
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .input{min-width: 180px}
    }

    .panel{
      background: linear-gradient(180deg, rgba(18,25,38,.88), rgba(15,22,34,.78));
      border:1px solid rgba(34,48,70,.75);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .head{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(34,48,70,.75);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panel .head h3{
      margin:0;
      font-size:16px;
      color: var(--text);
    }
    .panel .body{padding: 12px 14px 14px}

    .toc a{
      display:block;
      text-decoration:none;
      color: var(--text);
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      transition: background .15s ease, border-color .15s ease;
    }
    .toc a small{display:block; color: var(--muted); margin-top:2px}
    .toc a:hover{
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.25);
    }
    .toc a.active{
      background: rgba(167,139,250,.12);
      border-color: rgba(167,139,250,.30);
    }

    .content{
      padding: 18px 18px 30px;
    }
    .section{
      padding: 16px 16px;
      border:1px solid rgba(34,48,70,.75);
      border-radius: var(--radius);
      background: rgba(18,25,38,.55);
      margin-bottom: 14px;
    }
    .section h2{
      margin:0 0 8px;
      font-size:20px;
    }
    .meta{
      color: var(--muted);
      font-size: 13px;
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom: 10px;
    }

    .tools{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 10px 0 0;
    }

    details{
      border:1px solid rgba(34,48,70,.7);
      border-radius: 14px;
      background: rgba(15,22,34,.55);
      padding: 10px 12px;
      margin: 10px 0 0;
    }
    summary{
      cursor:pointer;
      color: var(--accent);
      font-weight:600;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}

    .flashgrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 700px){ .flashgrid{grid-template-columns:1fr} }

    .card{
      border:1px solid rgba(34,48,70,.75);
      border-radius: 16px;
      background: rgba(11,15,20,.25);
      padding: 12px 12px;
    }
    .card .q{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .card .a{
      font-size: 18px;
      font-weight:700;
    }
    .card .reveal{
      margin-top:8px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    mark{
      background: rgba(251,191,36,.25);
      color: var(--text);
      padding: 0 .15em;
      border-radius: 6px;
    }

    .footer{
      color: var(--muted);
      font-size: 12px;
      padding: 10px 0 0;
    }

    .progress{
      height: 10px;
      border-radius: 999px;
      background: rgba(34,48,70,.6);
      overflow:hidden;
      border:1px solid rgba(34,48,70,.8);
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(125,211,252,.9), rgba(167,139,250,.9));
      transition: width .2s ease;
    }

    .note{
      width:100%;
      min-height: 110px;
      resize: vertical;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(34,48,70,.75);
      background: rgba(18,25,38,.55);
      color: var(--muted);
      font-size: 12px;
    }

    @media print {
      header, aside, .tools, button, details, .footer { display: none !important; }
      body { background: white; color: black; }
      .panel { border: none; box-shadow: none; background: white; }
      .section { page-break-inside: avoid; border-color: #ddd; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        ูุชุงุจ ุงููุฑุงุฆุถ โ ูุณุฎุฉ ููุญูุธ
        <span class="badge">ุจุญุซ โข ุจุทุงูุงุช โข ุงุฎุชุจุงุฑ โข ูุคูุช</span>
      </div>

      <div class="controls">
        <input id="search" class="input" type="search" placeholder="ุงุจุญุซ ูู ุงููุต..." />
        <button class="btn ghost" id="toggleMarks">ุฅุฎูุงุก ุงูุชุญุฏูุฏ</button>
        <button class="btn primary" id="toggleFocus">ูุถุน ุงูุญูุธ</button>
        <button class="btn ghost" id="toggleDark">๐</button>
        <button class="btn ghost" id="printBtn">๐จ๏ธ</button>
        <select id="fontSize" title="ุญุฌู ุงูุฎุท">
          <option value="18">18</option>
          <option value="20" selected>20</option>
          <option value="22">22</option>
          <option value="24">24</option>
          <option value="26">26</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <div class="pill">v2.0</div>
      <div class="pill" id="stats">0 ูุณู โข 0 ุจุทุงูุฉ</div>
      <div class="pill" id="timerDisplay" style="display:none">โฑ๏ธ 00:00</div>
      <div style="flex:1"></div>
      <div style="min-width:240px; width:320px;">
        <div class="progress" title="ุชูุฏูู ุงููุฑุงุกุฉ">
          <div id="bar"></div>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <aside class="panel">
      <div class="head">
        <h3>ููุฑุณ</h3>
        <button class="btn ghost" id="clearProgress">ุชุตููุฑ</button>
      </div>
      <div class="body">
        <div class="toc" id="toc"></div>

        <details>
          <summary>๐ ููุงุญุธุงุชู</summary>
          <textarea id="notes" class="input note" placeholder="ุงูุชุจ ููุงุญุธุงุชู ููุง..."></textarea>
        </details>

        <details>
          <summary>โฑ๏ธ ูุคูุช ุงูุฏุฑุงุณุฉ</summary>
          <div style="display:flex; gap:8px; margin:10px 0; flex-wrap:wrap;">
            <button class="btn primary" id="startTimer">โถ๏ธ ุงุจุฏุฃ</button>
            <button class="btn ghost" id="pauseTimer">โธ๏ธ ููู</button>
            <button class="btn ghost" id="resetTimer">๐ ุฅุนุงุฏุฉ</button>
          </div>
          <div class="pill" id="totalTime">ุฅุฌูุงูู: 0 ุฏูููุฉ</div>
        </details>

        <details>
          <summary>๐ง ุงุฎุชุจุงุฑ ุณุฑูุน</summary>
          <div id="quiz"></div>
          <div class="tools">
            <button class="btn primary" id="newQuiz">ุงุฎุชุจุงุฑ ุฌุฏูุฏ</button>
            <button class="btn ghost" id="showAnswers">ุฅุธูุงุฑ ุงูุฅุฌุงุจุงุช</button>
          </div>
        </details>

        <details>
          <summary>๐ ุฅุญุตุงุฆูุงุช</summary>
          <div id="statsPanel" style="margin-top:10px; font-size:14px;">
            <div class="pill" style="width:100%; margin-bottom:8px;">
              ุงูุฃูุณุงู: <b id="completedSections">0/0</b>
            </div>
            <div class="pill" style="width:100%; margin-bottom:8px;">
              ููุช ุงูุฏุฑุงุณุฉ: <b id="studyTimeTotal">0</b> ุฏ
            </div>
            <div class="pill" style="width:100%; margin-bottom:8px;">
              ุขุฎุฑ ุฒูุงุฑุฉ: <b id="lastVisit">---</b>
            </div>
            <div class="pill" style="width:100%;">
              ุงูุฅูุฌุงุฒ: <b id="achievement">0%</b>
            </div>
          </div>
        </details>

        <details>
          <summary>๐พ ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช</summary>
          <div class="tools">
            <button class="btn primary" id="exportData">ุชุตุฏูุฑ</button>
            <button class="btn ghost" id="importData">ุงุณุชูุฑุงุฏ</button>
          </div>
          <input type="file" id="importFile" accept=".json" style="display:none">
        </details>

        <div class="footer">
          โ ูู ุดูุก ูุญูุธ ุชููุงุฆูุงู<br>
          โก ูุนูู ุนูู ุงููุงุชู ูุงูุญุงุณูุจ<br>
          <small style="color: var(--muted);">ุงููุณุฎุฉ ุงููุญุณููุฉ v2.0</small>
        </div>
      </div>
    </aside>

    <section class="panel">
      <div class="head">
        <h3 id="currentTitle">ุงููุญุชูู</h3>
        <div class="tools">
          <button class="btn ghost" id="bookmarkBtn">โญ ุนูุงูุฉ</button>
          <button class="btn ghost" id="copyLinkBtn">๐ ุฑุงุจุท</button>
          <button class="btn ghost" id="readAloud">๐ ูุฑุงุกุฉ</button>
        </div>
      </div>

      <div class="content" id="content"></div>
    </section>
  </div>
</main>

<script>
const sections = [
  {
    id: "t1",
    title: "ุชุนุฑูู ุงูููุฑุงุซ ูุบุฉู ูุงุตุทูุงุญูุง",
    subtitle: "ุงูููุงููู ุงูุฃุณุงุณูุฉ",
    body: `
<p><b>ุชุนุฑูู ุงูููุฑุงุซ ูุบุฉู:</b> ุงูููุฑุงุซ ูุตุฏุฑ ูู ูุฑุซุ ููู ุงูุชูุงู ุงูุดูุก ูู ุดุฎุต ุฅูู ุดุฎุต ุขุฎุฑ ุจุนุฏ ููุชู.</p>
<p><b>ูุงุตุทูุงุญูุง:</b> ุนุจุงุฑุฉ ุนู ุงูุชูุงู ููู ุฃุญุฏ ุจุณุจุจ ุงูููุช ุฅูู ูุฑุซุชู ุงูุญููููุฉ ุจุงูุทุฑู ุงูุดุฑุนูุฉ.</p>
<p>ุงูููุฑุงุซ ุญู ููุฏุณ ูู ุงูุฅุณูุงูุ ููุฏ ูุตูู ุงููู ุชุนุงูู ุฃุญูุงูู ูู ุงููุฑุขู ุงููุฑูู ูู ุขูุงุช ุณูุฑุฉ ุงููุณุงุก.</p>
`,
    flashcards: [
      {q:"ุชุนุฑูู ุงูููุฑุงุซ ูุบุฉูุ", a:"ุงูุชูุงู ุงูุดูุก ูู ุดุฎุต ูุขุฎุฑ ุจุนุฏ ููุชู"},
      {q:"ุชุนุฑูู ุงูููุฑุงุซ ุงุตุทูุงุญูุงุ", a:"ุงูุชูุงู ููู ุงูููุช ููุฑุซุชู ุจุงูุทุฑู ุงูุดุฑุนูุฉ"}
    ],
    quiz: [
      {q:"ูู ุนุฏุฏ ุฃุฑูุงู ุงูููุฑุงุซุ", a:"ุซูุงุซุฉ ุฃุฑูุงู"},
      {q:"ุฃูู ูุตูู ุงููู ุฃุญูุงู ุงูููุฑุงุซุ", a:"ูู ุณูุฑุฉ ุงููุณุงุก"}
    ]
  },

  {
    id: "t2",
    title: "ุชุนุฑูู ุนูู ุงููุฑุงุฆุถ",
    subtitle: "ุงูุนูู ูุงูููุถูุน",
    body: `
<p><b>ุนูู ุงููุฑุงุฆุถ:</b> ูู ุนูู ููุจุญุซ ููู ุนู ุงูุชูุงู ููู ุงูููุช ุฅูู ูุฑุซุชู ุงูุฃุญูุงุกุ ูุนู ุฃุญูุงู ุงููุฑุซุฉุ ูุงูุณูุงู ุงูููุฏูุฑุฉ ููู ุดุฑุนุงู.</p>
<p><b>ููุถูุนู:</b> ุงูุชุฑูุฉ ูุงูุณูุงู ููุณุชุญูููุง.</p>
<p><b>ูุงุฆุฏุชู:</b> ูุนุฑูุฉ ููููุฉ ูุณูุฉ ุงูุชุฑูุฉ ุนูู ุงููุฑุซุฉ ุญุณุจ ุงูุดุฑุนุ ูุฅูุตุงู ุงูุญููู ูุฃุตุญุงุจูุง.</p>
<p><b>ุณุจุจ ุงูุชุณููุฉ:</b> ุณูู ุจุนูู ุงููุฑุงุฆุถ ูุฃู ูุณุงุฆูู ูุจููุฉ ุนูู ุงููุฑูุถ ุงูููุฏูุฑุฉ ูู ูุชุงุจ ุงููู.</p>
`,
    flashcards: [
      {q:"ูุง ููุถูุน ุนูู ุงููุฑุงุฆุถุ", a:"ุงูุชุฑูุฉ ูุงูุณูุงู ููุณุชุญูููุง"},
      {q:"ููุงุฐุง ุณูู ุจุนูู ุงููุฑุงุฆุถุ", a:"ูุฃู ูุณุงุฆูู ูุจููุฉ ุนูู ุงููุฑูุถ ุงูููุฏูุฑุฉ"}
    ],
    quiz: [
      {q:"ูุง ูุงุฆุฏุฉ ุนูู ุงููุฑุงุฆุถุ", a:"ูุณูุฉ ุงูุชุฑูุฉ ูุฅูุตุงู ุงูุญููู"}
    ]
  },

  {
    id: "t3",
    title: "ุงููุตุทูุญุงุช ุงูุฃุณุงุณูุฉ",
    subtitle: "ูุงููุณ ุงููุฑุงุฆุถ",
    body: `
<ul>
  <li><b>ุงููุฑุถ:</b> ุงููุตูุจ ุงูููุฏุฑ ุดุฑุนุงู ูููุงุฑุซ ูู ุงูุชุฑูุฉ.</li>
  <li><b>ุงูุณูู:</b> ุงูุฌุฒุก ุงููุนูู ุงูุฐู ููุนุทู ููู ูุงุฑุซ ูู ุงูุชุฑูุฉ.</li>
  <li><b>ุงูุชุฑูุฉ (ุงูุฅุฑุซ):</b> ูุง ุชุฑูู ุงูููุช ูู ุงูุฃููุงู ูุงูุญููู ุจุนุฏ ุณุฏุงุฏ ุงูุฏููู ูุชูููุฐ ุงููุตุงูุง.</li>
  <li><b>ุงูููุฑุซ:</b> ุงูููุช ุงูุฐู ุงูุชูู ูุงูู ููุฑุซุชู.</li>
  <li><b>ุงููุงุฑุซ:</b> ุงูุดุฎุต ุงูุญู ุงูุฐู ูุณุชุญู ูุตูุจุงู ูู ุงูุชุฑูุฉ.</li>
  <li><b>ุงูุญุฌุจ:</b> ููุน ุงููุงุฑุซ ูู ุงูุฅุฑุซ ูููุงู ุฃู ููุต ูุตูุจู.</li>
  <li><b>ุงูุนุตุจุฉ:</b> ูู ูุฑุซ ุจูุง ุชูุฏูุฑ ููุฃุฎุฐ ูุง ุจูู ุจุนุฏ ุฃุตุญุงุจ ุงููุฑูุถ.</li>
</ul>
`,
    flashcards: [
      {q:"ูุง ูู ุงููุฑุถุ", a:"ุงููุตูุจ ุงูููุฏุฑ ุดุฑุนุงู ูููุงุฑุซ"},
      {q:"ูุง ูู ุงูุชุฑูุฉุ", a:"ูุง ุชุฑูู ุงูููุช ุจุนุฏ ุงูุฏููู ูุงููุตุงูุง"},
      {q:"ูู ูู ุงูููุฑุซุ", a:"ุงูููุช ุงูุฐู ุงูุชูู ูุงูู"}
    ],
    quiz: [
      {q:"ุงุฐูุฑ ุงููุฑู ุจูู ุงููุฑุถ ูุงูุนุตุจุฉ.", a:"ุงููุฑุถ ููุฏุฑุ ุงูุนุตุจุฉ ุชุฃุฎุฐ ุงูุจุงูู"}
    ]
  },

  {
    id: "t4",
    title: "ุฃุฑูุงู ุงูููุฑุงุซ ูุฃุณุจุงุจู ูุดุฑูุทู",
    subtitle: "ุงูุฃุณุงุณูุงุช ุงูุซูุงุซ",
    body: `
<p><b>ุฃุฑูุงู ุงูููุฑุงุซ (3):</b></p>
<ol>
  <li>ุงูููุฑุซ (ุงูููุช)</li>
  <li>ุงููุงุฑุซ (ุงูุญู)</li>
  <li>ุงูููุฑูุซ (ุงูุชุฑูุฉ)</li>
</ol>

<p><b>ุฃุณุจุงุจ ุงูุฅุฑุซ (4):</b></p>
<ol>
  <li><b>ุงููุณุจ:</b> ุงููุฑุงุจุฉ ุจุงูุฏู</li>
  <li><b>ุงูููุงุญ:</b> ุงูุฒูุฌูุฉ ุงูุดุฑุนูุฉ</li>
  <li><b>ุงูููุงุก:</b> ุณุจุจ ุงูุฅุฑุซ ุจุงูุนุชู</li>
  <li><b>ุจูุช ุงููุงู:</b> ุนูุฏ ุนุฏู ูุฌูุฏ ูุงุฑุซ</li>
</ol>

<p><b>ุดุฑูุท ุงูุฅุฑุซ (3):</b></p>
<ol>
  <li>ุชุญูู ููุช ุงูููุฑุซ ุญูููุฉ ุฃู ุญููุงู</li>
  <li>ุชุญูู ุญูุงุฉ ุงููุงุฑุซ ุจุนุฏ ููุช ุงูููุฑุซ</li>
  <li>ุงูุนูู ุจุงูุฌูุฉ ุงูููุชุถูุฉ ููุฅุฑุซ (ูุณุจ ุฃู ููุงุญ...)</li>
</ol>
`,
    flashcards: [
      {q:"ุฃุฑูุงู ุงูููุฑุงุซุ", a:"ุงูููุฑุซุ ุงููุงุฑุซุ ุงูููุฑูุซ"},
      {q:"ุฃุณุจุงุจ ุงูุฅุฑุซ ุงูุฃุฑุจุนุฉุ", a:"ุงููุณุจุ ุงูููุงุญุ ุงูููุงุกุ ุจูุช ุงููุงู"},
      {q:"ุดุฑูุท ุงูุฅุฑุซุ", a:"ููุช ุงูููุฑุซุ ุญูุงุฉ ุงููุงุฑุซุ ุงูุนูู ุจุงูุฌูุฉ"}
    ],
    quiz: [
      {q:"ูุชู ูุฑุซ ุจูุช ุงููุงูุ", a:"ุนูุฏ ุนุฏู ูุฌูุฏ ูุงุฑุซ"}
    ]
  },

  {
    id: "t5",
    title: "ููุงูุน ุงูุฅุฑุซ",
    subtitle: "ูุง ูููุน ุงูุชูุฑูุซ",
    body: `
<p>ููุงู ุซูุงุซุฉ ููุงูุน ุชููุน ูู ุงูุฅุฑุซ:</p>
<ol>
  <li><b>ุงูุฑู (ุงูุนุจูุฏูุฉ):</b> ุงูุนุจุฏ ูุง ูุฑุซ ููุง ููุฑุซ (ููุบู ูู ุนุตุฑูุง)</li>
  <li><b>ุงููุชู ุงูุนูุฏ:</b> ูู ูุชู ููุฑุซู ุนูุฏุงู ูุง ูุฑุซ ููู</li>
  <li><b>ุงุฎุชูุงู ุงูุฏูู:</b> ูุง ูุฑุซ ุงููุณูู ุงููุงูุฑ ููุง ุงููุงูุฑ ุงููุณูู</li>
</ol>
<p><b>ุงูุญููุฉ:</b> ุญูุงูุฉ ุงูุญููู ูููุน ุงูุธูู ูุงูุงุณุชุบูุงู.</p>
`,
    flashcards: [
      {q:"ููุงูุน ุงูุฅุฑุซ ุงูุซูุงุซุฉุ", a:"ุงูุฑูุ ุงููุชู ุงูุนูุฏุ ุงุฎุชูุงู ุงูุฏูู"},
      {q:"ูู ูุฑุซ ุงููุงุชู ูู ูุชููุ", a:"ูุงุ ุงููุงุชู ูุง ูุฑุซ"}
    ],
    quiz: [
      {q:"ูุง ุญูู ุชูุฑูุซ ุงููุณูู ูู ุงููุงูุฑุ", a:"ูุง ูุฑุซุ ูุงุฎุชูุงู ุงูุฏูู"}
    ]
  },

  {
    id: "t6",
    title: "ุงููุฑูุถ ุงูููุฏุฑุฉ",
    subtitle: "ุงูุฃูุตุจุฉ ุงูุณุชุฉ",
    body: `
<p>ุงููุฑูุถ ุงูููุฏุฑุฉ ูู ุงููุฑุขู ุณุชุฉ:</p>

<ol>
  <li><b>ุงููุตู (ยฝ):</b> 
    <ul>
      <li>ุงูุฒูุฌ ุนูุฏ ุนุฏู ุงููุฑุน ุงููุงุฑุซ</li>
      <li>ุงูุจูุช ุงููุงุญุฏุฉ</li>
      <li>ุจูุช ุงูุงุจู ุงููุงุญุฏุฉ (ุนูุฏ ุนุฏู ุงูุจูุช)</li>
      <li>ุงูุฃุฎุช ุงูุดูููุฉ ุงููุงุญุฏุฉ</li>
      <li>ุงูุฃุฎุช ูุฃุจ ุงููุงุญุฏุฉ</li>
    </ul>
  </li>

  <li><b>ุงูุฑุจุน (ยผ):</b>
    <ul>
      <li>ุงูุฒูุฌ ูุน ุงููุฑุน ุงููุงุฑุซ</li>
      <li>ุงูุฒูุฌุฉ ุนูุฏ ุนุฏู ุงููุฑุน ุงููุงุฑุซ</li>
    </ul>
  </li>

  <li><b>ุงูุซูู (โ):</b>
    <ul>
      <li>ุงูุฒูุฌุฉ ุฃู ุงูุฒูุฌุงุช ูุน ุงููุฑุน ุงููุงุฑุซ</li>
    </ul>
  </li>

  <li><b>ุงูุซูุซุงู (โ):</b>
    <ul>
      <li>ุงูุจูุชุงู ูุฃูุซุฑ</li>
      <li>ุจูุชุง ุงูุงุจู ูุฃูุซุฑ</li>
      <li>ุงูุฃุฎุชุงู ุงูุดูููุชุงู ูุฃูุซุฑ</li>
      <li>ุงูุฃุฎุชุงู ูุฃุจ ูุฃูุซุฑ</li>
    </ul>
  </li>

  <li><b>ุงูุซูุซ (โ):</b>
    <ul>
      <li>ุงูุฃู ุนูุฏ ุนุฏู ุงููุฑุน ูุงูุฌูุน ูู ุงูุฅุฎูุฉ</li>
      <li>ุงูุงุซูุงู ูุฃูุซุฑ ูู ุงูุฅุฎูุฉ ูุฃู</li>
    </ul>
  </li>

  <li><b>ุงูุณุฏุณ (โ):</b>
    <ul>
      <li>ุงูุฃุจ ูุน ุงููุฑุน ุงููุงุฑุซ ุงููุฐูุฑ</li>
      <li>ุงูุฃู ูุน ุงููุฑุน ุฃู ุฌูุน ุงูุฅุฎูุฉ</li>
      <li>ุงูุฌุฏุฉ ุฃู ุงูุฌุฏุงุช</li>
      <li>ุจูุช ุงูุงุจู ูุน ุงูุจูุช</li>
      <li>ุงูุฃุฎุช ูุฃุจ ูุน ุงูุฃุฎุช ุงูุดูููุฉ</li>
      <li>ุงูุฃุฎ ูุฃู ุฃู ุงูุฃุฎุช ูุฃู</li>
    </ul>
  </li>
</ol>
`,
    flashcards: [
      {q:"ูู ุนุฏุฏ ุงููุฑูุถ ุงูููุฏุฑุฉุ", a:"ุณุชุฉ ูุฑูุถ"},
      {q:"ูุชู ูุฃุฎุฐ ุงูุฒูุฌ ุงููุตูุ", a:"ุนูุฏ ุนุฏู ุงููุฑุน ุงููุงุฑุซ"},
      {q:"ูุชู ุชุฃุฎุฐ ุงูุฒูุฌุฉ ุงูุซููุ", a:"ูุน ูุฌูุฏ ุงููุฑุน ุงููุงุฑุซ"},
      {q:"ูู ูุฃุฎุฐ ุงูุซูุซููุ", a:"ุงูุจูุชุงู ูุฃูุซุฑุ ุงูุฃุฎุชุงู ูุฃูุซุฑ"}
    ],
    quiz: [
      {q:"ุงุฐูุฑ ุซูุงุซุฉ ูู ุฃุตุญุงุจ ุงููุตู.", a:"ุงูุฒูุฌุ ุงูุจูุชุ ุงูุฃุฎุช ุงูุดูููุฉ"},
      {q:"ูุชู ุชุฃุฎุฐ ุงูุฃู ุงูุซูุซุ", a:"ุนูุฏ ุนุฏู ุงููุฑุน ูุฌูุน ุงูุฅุฎูุฉ"}
    ]
  },

  {
    id: "t7",
    title: "ุงูุนุตุจุงุช",
    subtitle: "ุงููุงุฑุซูู ุจูุง ุชูุฏูุฑ",
    body: `
<p><b>ุงูุนุตุจุฉ:</b> ูู ูุฑุซ ุจูุง ุชูุฏูุฑุ ููุฃุฎุฐ ุฌููุน ุงููุงู ุฅู ุงููุฑุฏุ ุฃู ุงูุจุงูู ุจุนุฏ ุฃุตุญุงุจ ุงููุฑูุถ.</p>

<p><b>ุฃููุงุน ุงูุนุตุจุงุช:</b></p>

<ol>
  <li><b>ุนุตุจุฉ ุจุงูููุณ:</b> ูู ุฐูุฑ ูู ุงููุณุจ ููุณ ุจููู ูุจูู ุงูููุช ุฃูุซู:
    <ul>
      <li>ุงูุจููู ูุจูููู ูุฅู ูุฒููุง</li>
      <li>ุงูุฃุจ ูุงูุฌุฏ ูุฅู ุนูุง</li>
      <li>ุงูุฅุฎูุฉ ุงูุฃุดูุงุก ูุจูููู</li>
      <li>ุงูุฅุฎูุฉ ูุฃุจ ูุจูููู</li>
      <li>ุงูุฃุนูุงู ุงูุฃุดูุงุก ูุจูููู</li>
      <li>ุงูุฃุนูุงู ูุฃุจ ูุจูููู</li>
    </ul>
  </li>

  <li><b>ุนุตุจุฉ ุจุงูุบูุฑ:</b> ุงูุฃูุซู ุงูุชู ุชุตูุฑ ุนุตุจุฉ ุจุณุจุจ ุฐูุฑ:
    <ul>
      <li>ุงูุจูุช ูุน ุงูุงุจู</li>
      <li>ุจูุช ุงูุงุจู ูุน ุงุจู ุงูุงุจู</li>
      <li>ุงูุฃุฎุช ุงูุดูููุฉ ูุน ุงูุฃุฎ ุงูุดููู</li>
      <li>ุงูุฃุฎุช ูุฃุจ ูุน ุงูุฃุฎ ูุฃุจ</li>
    </ul>
  </li>

  <li><b>ุนุตุจุฉ ูุน ุงูุบูุฑ:</b> 
    <ul>
      <li>ุงูุฃุฎุช ุงูุดูููุฉ ุฃู ูุฃุจ ูุน ุงูุจูุช ุฃู ุจูุช ุงูุงุจู</li>
    </ul>
  </li>
</ol>

<p><b>ูุงุนุฏุฉ:</b> ููุฐูุฑ ูุซู ุญุธ ุงูุฃูุซููู ูู ุงูุนุตุจุฉ ุจุงูุบูุฑ.</p>
`,
    flashcards: [
      {q:"ูุง ูู ุงูุนุตุจุฉุ", a:"ูู ูุฑุซ ุจูุง ุชูุฏูุฑ ููุฃุฎุฐ ุงูุจุงูู"},
      {q:"ุงุฐูุฑ ุฃููุงุน ุงูุนุตุจุงุช.", a:"ุจุงูููุณุ ุจุงูุบูุฑุ ูุน ุงูุบูุฑ"},
      {q:"ูุซุงู ุงูุนุตุจุฉ ุจุงูุบูุฑุ", a:"ุงูุจูุช ูุน ุงูุงุจู"}
    ],
    quiz: [
      {q:"ูุชู ุชุตุจุญ ุงูุฃุฎุช ุนุตุจุฉ ูุน ุงูุบูุฑุ", a:"ูุน ุงูุจูุช ุฃู ุจูุช ุงูุงุจู"}
    ]
  },

  {
    id: "t8",
    title: "ุงูุญุฌุจ",
    subtitle: "ุงูููุน ูู ุงูุฅุฑุซ",
    body: `
<p><b>ุงูุญุฌุจ:</b> ููุน ูู ูุงู ุจู ุณุจุจ ุงูุฅุฑุซ ูู ุงูุฅุฑุซ ุจุงููููุฉ ุฃู ูู ุฃููุฑู.</p>

<p><b>ููุนุง ุงูุญุฌุจ:</b></p>

<ol>
  <li><b>ุญุฌุจ ุญุฑูุงู:</b> ููุน ุงููุงุฑุซ ูู ุงูุฅุฑุซ ุจุงููููุฉ
    <p><b>ูุซุงู:</b> ุงูุงุจู ูุญุฌุจ ุงูุฃุฎุ ูุงูุฃุจ ูุญุฌุจ ุงูุฌุฏ</p>
  </li>

  <li><b>ุญุฌุจ ููุตุงู:</b> ููุต ูุตูุจ ุงููุงุฑุซ ูู ูุฑุถ ุฃูุซุฑ ุฅูู ุฃูู
    <p><b>ูุซุงู:</b> ุงูุฒูุฌ ููุชูู ูู ุงููุตู ุฅูู ุงูุฑุจุน ุจูุฌูุฏ ุงููุฑุน</p>
  </li>
</ol>

<p><b>ูู ูุง ููุญุฌุจ ุญุฌุจ ุญุฑูุงู:</b></p>
<ul>
  <li>ุงูุฃุจูุงู (ููู ูุญุฌุจุงู ุญุฌุจ ููุตุงู)</li>
  <li>ุงูุฒูุฌุงู (ููู ูุญุฌุจุงู ุญุฌุจ ููุตุงู)</li>
  <li>ุงูุฃููุงุฏ (ุงูุจููู ูุงูุจูุงุช)</li>
</ul>

<p><b>ูุงุนุฏุฉ:</b> ุงูุฃูุฑุจ ูุญุฌุจ ุงูุฃุจุนุฏ (ุงูุงุจู ูุญุฌุจ ุงุจู ุงูุงุจู)</p>
`,
    flashcards: [
      {q:"ูุง ูู ุงูุญุฌุจุ", a:"ููุน ุงููุงุฑุซ ูู ุงูุฅุฑุซ ูููุงู ุฃู ููุตุงู"},
      {q:"ูู ูุง ููุญุฌุจ ุญุฌุจ ุญุฑูุงูุ", a:"ุงูุฃุจูุงูุ ุงูุฒูุฌุงูุ ุงูุฃููุงุฏ"},
      {q:"ุงุฐูุฑ ูุงุนุฏุฉ ุงูุญุฌุจ.", a:"ุงูุฃูุฑุจ ูุญุฌุจ ุงูุฃุจุนุฏ"}
    ],
    quiz: [
      {q:"ูุง ุงููุฑู ุจูู ุญุฌุจ ุงูุญุฑูุงู ูุงูููุตุงูุ", a:"ุงูุญุฑูุงู: ููุน ูุงููุ ุงูููุตุงู: ุชูููู ุงููุตูุจ"}
    ]
  },

  {
    id: "t9",
    title: "ุฃูุซูุฉ ุนูููุฉ",
    subtitle: "ุชุทุจููุงุช ุนูู ุงููุณูุฉ",
    body: `
<p><b>ูุซุงู 1:</b> ุชููู ุนู: ุฒูุฌุฉ + ุจูุช + ุงุจู</p>
<ul>
  <li>ุงูุฒูุฌุฉ: ุงูุซูู (โ) = 1 ูู 8</li>
  <li>ุงูุจุงูู ููุฃููุงุฏ ุจุงูุชุนุตูุจ (โ = 7)</li>
  <li>ุงูุงุจู: 2 ร ุณูู ุงูุจูุช</li>
  <li>ุชูุณูู ุงูุณุจุนุฉ: ุงูุงุจู 4 + ุงูุจูุช 2 + ุงูุจูุช 1 (ุฅู ูุงูุช ุฃุฎุฑู)</li>
</ul>

<p><b>ูุซุงู 2:</b> ุชููู ุนู: ุฒูุฌ + ุจูุชูู + ุฃุจ</p>
<ul>
  <li>ุงูุฒูุฌ: ุงูุฑุจุน (ยผ)</li>
  <li>ุงูุจูุชุงู: ุงูุซูุซุงู (โ)</li>
  <li>ุงูุฃุจ: ุงูุณุฏุณ (โ) + ุงูุจุงูู ุจุงูุชุนุตูุจ</li>
</ul>

<p><b>ูุซุงู 3:</b> ุชูููุช ุนู: ุฒูุฌ + ุฃู + ุฃุฎ ุดููู</p>
<ul>
  <li>ุงูุฒูุฌ: ุงููุตู (ยฝ)</li>
  <li>ุงูุฃู: ุงูุซูุซ (โ)</li>
  <li>ุงูุฃุฎ: ุงูุจุงูู ุจุงูุชุนุตูุจ (โ)</li>
</ul>

<p><b>ููุงุญุธุฉ:</b> ูุฐู ุฃูุซูุฉ ูุจุณุทุฉุ ูุงูุญุงูุงุช ุงูุญููููุฉ ูุฏ ุชุญุชุงุฌ ูุชุตุญูุญ ูุนูู.</p>
`,
    flashcards: [
      {q:"ูุง ูุตูุจ ุงูุฒูุฌุฉ ูุน ูุฌูุฏ ุงูุฃููุงุฏุ", a:"ุงูุซูู"},
      {q:"ููู ููุณู ุงูุจุงูู ุจูู ุงูุฐูุฑ ูุงูุฃูุซูุ", a:"ููุฐูุฑ ูุซู ุญุธ ุงูุฃูุซููู"}
    ],
    quiz: [
      {q:"ุฅุฐุง ุชููู ุนู ุฒูุฌุฉ ูุงุจูุ ูู ูุตูุจ ุงูุฒูุฌุฉุ", a:"ุงูุซูู"}
    ]
  },

  {
    id: "t10",
    title: "ุงูุชุฏุฑูุจุงุช ูุงููุฑุงุฌุนุฉ",
    subtitle: "ุงุฎุชุจุฑ ูุนูููุงุชู",
    body: `
<p><b>ุฃุณุฆูุฉ ุงููุฑุงุฌุนุฉ:</b></p>

<ol>
  <li>ุงุฐูุฑ ุชุนุฑูู ุนูู ุงูููุฑุงุซ ูุบุฉู ูุงุตุทูุงุญุงู.</li>
  <li>ุจููู ุฃุฑูุงู ุงูููุฑุงุซ ุงูุซูุงุซุฉ.</li>
  <li>ูุง ูู ุฃุณุจุงุจ ุงูุฅุฑุซุ ููุง ูู ุดุฑูุทูุ</li>
  <li>ุงุฐูุฑ ููุงูุน ุงูุฅุฑุซ ุงูุซูุงุซุฉ.</li>
  <li>ูู ุนุฏุฏ ุงููุฑูุถ ุงูููุฏุฑุฉุ ุงุฐูุฑูุง.</li>
  <li>ูุง ุงููุฑู ุจูู ุฃุตุญุงุจ ุงููุฑูุถ ูุงูุนุตุจุงุชุ</li>
  <li>ูุชู ูุฃุฎุฐ ุงูุฒูุฌ ุงููุตูุ ููุชู ูุฃุฎุฐ ุงูุฑุจุนุ</li>
  <li>ูู ูู ุงูุฐูู ูุง ููุญุฌุจูู ุญุฌุจ ุญุฑูุงูุ</li>
  <li>ุงุฐูุฑ ุฃููุงุน ุงูุนุตุจุงุช ุงูุซูุงุซุฉ.</li>
  <li>ูุง ูู ูุงุนุฏุฉ ุงูุญุฌุจ ุงูุฃุณุงุณูุฉุ</li>
</ol>

<p><b>ุชูุงุฑูู ุนูููุฉ:</b></p>

<ol>
  <li>ุชููู ุนู: ุฒูุฌุฉ + ุงุจู + ุจูุช - ุงุญุณุจ ุงูุฃูุตุจุฉ</li>
  <li>ุชููู ุนู: ุฒูุฌ + ุฃู + ุฃุจ - ุงุญุณุจ ุงูุฃูุตุจุฉ</li>
  <li>ุชูููุช ุนู: ุฒูุฌ + ุจูุชูู + ุฃุฎ - ุงุญุณุจ ุงูุฃูุตุจุฉ</li>
</ol>

<p><b>ูุตูุญุฉ:</b> ุฃุนุฏ ูุฑุงุกุฉ ุงูุฃูุณุงู ุงูุณุงุจูุฉ ูุญู ุงูุฃูุซูุฉ ุจููุณู.</p>
`,
    quiz: [
      {q:"ูุง ุฃูู ูุตูุญุฉ ูุฅุชูุงู ุนูู ุงูููุฑุงุซุ", a:"ุงูููุงุฑุณุฉ ูุงูุชุทุจูู ุงููุณุชูุฑ"}
    ]
  }
];

const $ = (s)=>document.querySelector(s);
const toc = $("#toc");
const content = $("#content");
const search = $("#search");
const stats = $("#stats");
const bar = $("#bar");
const currentTitle = $("#currentTitle");

const LS = {
  key: "faraid_book_v2",
  load(){ try{ return JSON.parse(localStorage.getItem(this.key) || "{}"); }catch(e){ return {}; } },
  save(data){ localStorage.setItem(this.key, JSON.stringify(data)); }
};

let state = LS.load();
state.progress = state.progress || {};
state.bookmark = state.bookmark || null;
state.notes = state.notes || "";
state.focus = state.focus || false;
state.hideMarks = state.hideMarks || false;
state.fontSize = state.fontSize || 20;
state.theme = state.theme || "dark";
state.studyTime = state.studyTime || 0;
state.lastVisit = state.lastVisit || Date.now();

let timerInterval = null;
let timerRunning = false;
let timerSeconds = 0;

function renderTOC(){
  toc.innerHTML = "";
  sections.forEach((sec, i)=>{
    const a = document.createElement("a");
    a.href = "#" + sec.id;
    a.dataset.id = sec.id;
    a.innerHTML = `${sec.title}<small>${sec.subtitle || ""} โข ${i+1}/${sections.length}</small>`;
    a.onclick = (e)=>{ e.preventDefault(); goTo(sec.id); };
    toc.appendChild(a);
  });
}

function renderContent(){
  content.innerHTML = "";
  let cardCount = 0;

  sections.forEach((sec)=>{
    const div = document.createElement("div");
    div.className = "section";
    div.id = sec.id;

    const metaBits = [];
    if (sec.subtitle) metaBits.push(sec.subtitle);
    if (sec.flashcards?.length) metaBits.push(`ุจุทุงูุงุช: ${sec.flashcards.length}`);
    if (sec.quiz?.length) metaBits.push(`ุฃุณุฆูุฉ: ${sec.quiz.length}`);

    div.innerHTML = `
      <h2>${sec.title}</h2>
      <div class="meta">${metaBits.map(x=>`<span class="pill">${x}</span>`).join("")}</div>
      <div class="text" style="font-size:${state.fontSize}px">${sec.body || ""}</div>
      ${sec.flashcards?.length ? flashHTML(sec.flashcards, sec.id) : ""}
      <div class="tools">
        <button class="btn ghost" data-mark="${sec.id}">โ ุชู</button>
        <button class="btn ghost" data-top="${sec.id}">โฌ๏ธ ููุฃุนูู</button>
      </div>
    `;
    content.appendChild(div);
    cardCount += (sec.flashcards?.length || 0);
  });

  stats.textContent = `${sections.length} ูุณู โข ${cardCount} ุจุทุงูุฉ`;
  attachSectionButtons();
}

function flashHTML(cards, secId){
  const html = cards.map((c, idx)=>`
    <div class="card" data-flash="${secId}:${idx}">
      <div class="q">ุณุคุงู</div>
      <div class="a">${escapeHTML(c.q)}</div>
      <div class="reveal">
        <button class="btn primary" data-reveal="${secId}:${idx}">ุฃุธูุฑ ุงูุฌูุงุจ</button>
        <span class="pill" data-answer="${secId}:${idx}" style="display:none">ุงูุฌูุงุจ: ${escapeHTML(c.a)}</span>
      </div>
    </div>
  `).join("");

  return `
    <details>
      <summary>๐ง ุจุทุงูุงุช ููุญูุธ</summary>
      <div class="flashgrid">${html}</div>
    </details>
  `;
}

function attachSectionButtons(){
  content.querySelectorAll("[data-reveal]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-reveal");
      const ans = content.querySelector(`[data-answer="${id}"]`);
      if (!ans) return;
      const isHidden = ans.style.display === "none";
      ans.style.display = isHidden ? "inline-flex" : "none";
      btn.textContent = isHidden ? "ุฃุฎูู ุงูุฌูุงุจ" : "ุฃุธูุฑ ุงูุฌูุงุจ";
      updateProgress();
    });
  });

  content.querySelectorAll("[data-mark]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-mark");
      state.progress[id] = 1;
      save();
      updateTOCActive(id);
      updateProgress();
      updateStats();
      toast("ุชู โ");
    });
  });

  content.querySelectorAll("[data-top]").forEach(btn=>{
    btn.addEventListener("click", ()=> window.scrollTo({top:0, behavior:"smooth"}));
  });
}

function updateTOCActive(id){
  toc.querySelectorAll("a").forEach(a=>a.classList.toggle("active", a.dataset.id === id));
  const sec = sections.find(s=>s.id===id);
  if (sec) currentTitle.textContent = sec.title;
}

function goTo(id){
  const el = document.getElementById(id);
  if (!el) return;
  el.scrollIntoView({behavior:"smooth", block:"start"});
  updateTOCActive(id);
  history.replaceState(null, "", "#" + id);
}

function updateProgress(){
  const done = Object.values(state.progress).filter(v=>v===1).length;
  const pct = Math.round((done / sections.length) * 100);
  bar.style.width = pct + "%";
}

function applyFocusMode(){
  const grid = document.querySelector(".grid");
  if (state.focus){
    grid.style.gridTemplateColumns = "1fr";
    document.querySelector("aside.panel").style.display = "none";
  } else {
    grid.style.gridTemplateColumns = "";
    document.querySelector("aside.panel").style.display = "";
  }
  $("#toggleFocus").textContent = state.focus ? "ุฅูุบุงุก ูุถุน ุงูุญูุธ" : "ูุถุน ุงูุญูุธ";
}

function applyMarks(){
  $("#toggleMarks").textContent = state.hideMarks ? "ุฅุธูุงุฑ ุงูุชุญุฏูุฏ" : "ุฅุฎูุงุก ุงูุชุญุฏูุฏ";
  if (state.hideMarks){
    content.querySelectorAll("mark").forEach(m=>{
      const t = document.createTextNode(m.textContent);
      m.replaceWith(t);
    });
  }
}

function applyFontSize(){
  $("#fontSize").value = String(state.fontSize);
  content.querySelectorAll(".text").forEach(t=>{
    t.style.fontSize = state.fontSize + "px";
  });
}

function doSearch(q){
  content.querySelectorAll("mark").forEach(m=>{
    const t = document.createTextNode(m.textContent);
    m.replaceWith(t);
  });
  if (!q || state.hideMarks) return;

  const rx = new RegExp(escapeRegExp(q), "g");
  content.querySelectorAll(".text").forEach(node=>{
    const html = node.innerHTML;
    node.innerHTML = html.replace(rx, (m)=>`<mark>${m}</mark>`);
  });
}

function buildQuiz(){
  const pool = [];
  sections.forEach(sec=>{
    (sec.quiz || []).forEach(item=> pool.push({secId: sec.id, ...item}));
  });
  const quizBox = $("#quiz");
  quizBox.innerHTML = "";

  if (!pool.length){
    quizBox.innerHTML = `<div class="pill">ูุง ููุฌุฏ ุงุฎุชุจุงุฑ.</div>`;
    return;
  }

  const pick = shuffle([...pool]).slice(0, Math.min(5, pool.length));
  pick.forEach((item, i)=>{
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="q">ุณุคุงู ${i+1} โข ${sections.find(s=>s.id===item.secId)?.title || ""}</div>
      <div class="a">${escapeHTML(item.q)}</div>
      <div class="reveal">
        <span class="pill ans" style="display:none">ุงูุฌูุงุจ: ${escapeHTML(item.a)}</span>
        <button class="btn primary show">ุฃุธูุฑ ุงูุฌูุงุจ</button>
        <button class="btn ghost goto">ุงุฐูุจ ูููุณู</button>
      </div>
    `;
    wrap.querySelector(".show").onclick = ()=>{
      const ans = wrap.querySelector(".ans");
      const isHidden = ans.style.display === "none";
      ans.style.display = isHidden ? "inline-flex" : "none";
    };
    wrap.querySelector(".goto").onclick = ()=> goTo(item.secId);
    quizBox.appendChild(wrap);
  });
}

function startTimer(){
  if (timerRunning) return;
  timerRunning = true;
  timerInterval = setInterval(()=>{
    timerSeconds++;
    updateTimerDisplay();
    if (timerSeconds % 60 === 0) {
      state.studyTime = (state.studyTime || 0) + 1;
      save();
      updateStats();
    }
  }, 1000);
  $("#timerDisplay").style.display = "inline-flex";
  toast("ุจุฏุฃ ุงููุคูุช โฑ๏ธ");
}

function pauseTimer(){
  if (!timerRunning) return;
  timerRunning = false;
  clearInterval(timerInterval);
  toast("ุชููู ุงููุคูุช โธ๏ธ");
}

function resetTimer(){
  pauseTimer();
  timerSeconds = 0;
  updateTimerDisplay();
  $("#timerDisplay").style.display = "none";
  toast("ุชู ุฅุนุงุฏุฉ ุงููุคูุช ๐");
}

function updateTimerDisplay(){
  const mins = Math.floor(timerSeconds / 60);
  const secs = timerSeconds % 60;
  const display = `โฑ๏ธ ${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  $("#timerDisplay").textContent = display;
}

function toggleTheme(){
  state.theme = state.theme === "dark" ? "light" : "dark";
  document.body.className = state.theme;
  save();
  toast(state.theme === "dark" ? "ุงููุถุน ุงูุฏุงูู ๐" : "ุงููุถุน ุงููุงุชุญ โ๏ธ");
}

let speechSynth = window.speechSynthesis;

function readAloud(){
  if (!speechSynth) {
    toast("ุงููุฑุงุกุฉ ุงูุตูุชูุฉ ุบูุฑ ูุฏุนููุฉ");
    return;
  }

  if (speechSynth.speaking) {
    speechSynth.cancel();
    $("#readAloud").textContent = "๐ ูุฑุงุกุฉ";
    return;
  }

  const currentId = location.hash?.slice(1) || sections[0].id;
  const sec = sections.find(s => s.id === currentId);
  if (!sec) return;

  const tempDiv = document.createElement("div");
  tempDiv.innerHTML = sec.body;
  const text = tempDiv.textContent || tempDiv.innerText || "";

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "ar-SA";
  utterance.rate = 0.9;
  
  utterance.onend = ()=>{
    $("#readAloud").textContent = "๐ ูุฑุงุกุฉ";
  };

  speechSynth.speak(utterance);
  $("#readAloud").textContent = "โน๏ธ ุฅููุงู";
  toast("ุจุฏุฃุช ุงููุฑุงุกุฉ ๐");
}

function printPage(){
  window.print();
}

function exportData(){
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `faraid_backup_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("ุชู ุงูุชุตุฏูุฑ ๐พ");
}

function importData(){
  $("#importFile").click();
}

$("#importFile").addEventListener("change", (e)=>{
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (ev)=>{
    try {
      const imported = JSON.parse(ev.target.result);
      Object.assign(state, imported);
      save();
      location.reload();
    } catch(err) {
      toast("ุฎุทุฃ ูู ุงูููู โ");
    }
  };
  reader.readAsText(file);
});

function updateStats(){
  const completed = Object.values(state.progress).filter(v=>v===1).length;
  $("#completedSections").textContent = `${completed}/${sections.length}`;
  $("#studyTimeTotal").textContent = state.studyTime || 0;
  $("#totalTime").textContent = `ุฅุฌูุงูู: ${state.studyTime || 0} ุฏูููุฉ`;
  
  const lastDate = new Date(state.lastVisit);
  $("#lastVisit").textContent = lastDate.toLocaleDateString("ar-SA");
  
  const achievement = Math.round((completed / sections.length) * 100);
  $("#achievement").textContent = achievement + "%";
}

function save(){ 
  state.lastVisit = Date.now();
  LS.save(state); 
}

function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, "\\  <li><b>ุนุตุจุฉ ุจ"); }
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function toast(msg){
  const t = document.createElement("div");
  t.textContent = msg;
  t.style.cssText = `
    position:fixed; bottom:18px; left:18px; padding:10px 12px;
    border-radius:14px; background:rgba(18,25,38,.92);
    border:1px solid rgba(34,48,70,.8);
    box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:999;
  `;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 1400);
}

$("#newQuiz").addEventListener("click", buildQuiz);
$("#showAnswers").addEventListener("click", ()=>{
  document.querySelectorAll("#quiz .ans").forEach(a=> a.style.display="inline-flex");
});

$("#toggleFocus").addEventListener("click", ()=>{
  state.focus = !state.focus;
  save();
  applyFocusMode();
});

$("#toggleMarks").addEventListener("click", ()=>{
  state.hideMarks = !state.hideMarks;
  save();
  applyMarks();
  doSearch(search.value.trim());
});

$("#clearProgress").addEventListener("click", ()=>{
  if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุชุตููุฑ ุงูุชูุฏููุ")) {
    state.progress = {};
    save();
    updateProgress();
    updateStats();
    toast("ุชู ุงูุชุตููุฑ.");
  }
});

$("#bookmarkBtn").addEventListener("click", ()=>{
  const id = location.hash?.slice(1) || sections[0].id;
  state.bookmark = id;
  save();
  toast("ุชู ุญูุธ ุงูุนูุงูุฉ โญ");
});

$("#copyLinkBtn").addEventListener("click", async ()=>{
  const id = location.hash?.slice(1) || sections[0].id;
  const url = location.origin + location.pathname + "#" + id;
  try{
    await navigator.clipboard.writeText(url);
    toast("ุชู ูุณุฎ ุงูุฑุงุจุท ๐");
  }catch(e){
    toast("ุชุนุฐุฑ ุงููุณุฎ");
  }
});

const notes = $("#notes");
notes.value = state.notes || "";
notes.addEventListener("input", ()=>{
  state.notes = notes.value;
  save();
});

search.addEventListener("input", ()=>{
  doSearch(search.value.trim());
});

$("#fontSize").addEventListener("change", (e)=>{
  state.fontSize = parseInt(e.target.value, 10);
  save();
  applyFontSize();
});

$("#startTimer").addEventListener("click", startTimer);
$("#pauseTimer").addEventListener("click", pauseTimer);
$("#resetTimer").addEventListener("click", resetTimer);
$("#toggleDark").addEventListener("click", toggleTheme);
$("#readAloud").addEventListener("click", readAloud);
$("#printBtn").addEventListener("click", printPage);
$("#exportData").addEventListener("click", exportData);
$("#importData").addEventListener("click", importData);

document.body.className = state.theme || "dark";
renderTOC();
renderContent();
applyFocusMode();
applyMarks();
applyFontSize();
buildQuiz();
updateProgress();
updateStats();

const initial = location.hash?.slice(1) || state.bookmark || sections[0].id;
setTimeout(()=> goTo(initial), 50);

window.addEventListener("scroll", ()=>{
  const tops = sections.map(s=>{
    const el = document.getElementById(s.id);
    if(!el) return {id:s.id, top: Infinity};
    const r = el.getBoundingClientRect();
    return {id:s.id, top: Math.abs(r.top - 120)};
  }).sort((a,b)=>a.top-b.top);
  if(tops[0]) updateTOCActive(tops[0].id);
});

window.addEventListener("beforeunload", ()=>{
  if (timerRunning) {
    state.studyTime = (state.studyTime || 0) + Math.floor(timerSeconds / 60);
    save();
  }
});
</script>
</body>
</html>
